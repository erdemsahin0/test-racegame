<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Nitro Lane Rush</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
</head>
<body>
<script>
// SCENE 1: THE START SCREEN
class StartScene extends Phaser.Scene {
    constructor() {
        super('StartScene');
    }

    create() {
        this.add.text(400, 200, 'Nitro Lane Rush', { fontSize: '48px', fill: '#fff' }).setOrigin(0.5);
        this.add.text(400, 300, 'Press SPACE or Tap to Start', { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
        this.game.canvas.setAttribute('tabindex', '0');
        this.game.canvas.focus();

        this.input.keyboard.once('keydown-SPACE', () => {
            this.scene.start('GameScene');
        });
        this.input.on('pointerdown', () => {
            this.scene.start('GameScene');
        });
    }
}

// SCENE 2: THE MAIN GAME
class GameScene extends Phaser.Scene {
    constructor() {
        super('GameScene');
        this.playerSpeed = 300;
        this.isDragging = false;
        this.score = 0;
        this.roadSpeed = 4;
        this.enemySpeed = 150;
        this.spawnDelay = 1500;

        // --- NEW: Lives and Invincibility ---
        this.lives = 3;
        this.isInvincible = false;
    }

    preload() {
        // (This function is unchanged)
        this.load.image('road', 'assets/road.png');
        this.load.image('player_car_hero', 'assets/player_car_hero.png');
        this.load.image('enemy_car_green', 'assets/enemy_car_green.png');
        this.load.image('enemy_car_yellow', 'assets/enemy_car_yellow.png');
        this.load.image('enemy_car_blue_sky', 'assets/enemy_car_blue_sky.png');
        this.load.image('enemy_car_police', 'assets/enemy_car_police.png');
    }

    create() {
        // --- NEW: Reset lives and score when the scene starts ---
        this.lives = 3;
        this.score = 0;
        this.isInvincible = false;
        this.roadSpeed = 4;
        this.enemySpeed = 150;
        this.spawnDelay = 1500;

        this.road = this.add.tileSprite(400, 300, 800, 600, 'road');
        this.car = this.physics.add.sprite(400, 500, 'player_car_hero');
        this.car.setCollideWorldBounds(true);
        this.car.body.setSize(60, 140);

        this.car.setInteractive();
        this.input.setDraggable(this.car);
        this.input.on('dragstart', () => { this.isDragging = true; });
        this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
            gameObject.x = dragX;
            gameObject.y = dragY;
        });
        this.input.on('dragend', () => { this.isDragging = false; });
        
        this.enemyCars = this.physics.add.group();
        this.spawnTimer = this.time.addEvent({
            delay: this.spawnDelay,
            callback: this.spawnEnemyCar,
            callbackScope: this,
            loop: true
        });

        this.physics.add.overlap(this.car, this.enemyCars, this.hitEnemy, null, this);
        this.cursors = this.input.keyboard.createCursorKeys();

        this.scoreText = this.add.text(16, 16, 'Score: 0', { 
            fontSize: '32px', 
            fill: '#fff',
            fontStyle: 'bold'
        });
        
        // --- NEW: LIVES DISPLAY ---
        // Display the lives in the top-right corner
        this.livesText = this.add.text(620, 16, 'Lives: 3', {
            fontSize: '32px',
            fill: '#fff',
            fontStyle: 'bold'
        });

        this.scoreTimer = this.time.addEvent({
            delay: 100,
            callback: this.updateScore,
            callbackScope: this,
            loop: true
        });
    }

    updateScore() {
        this.score += 1;
        this.scoreText.setText('Score: ' + this.score);

        if (this.score > 0 && this.score % 200 === 0 && this.spawnDelay > 600) {
            this.roadSpeed += 0.5;
            this.enemySpeed += 20;
            this.spawnTimer.delay *= 0.95;
            console.log(`SPEED UP! New spawn delay: ${this.spawnTimer.delay.toFixed(0)}ms`);
        }
    }

    spawnEnemyCar() {
        const x = Phaser.Math.Between(100, 700);
        const y = -50;
        const carTypes = ['enemy_car_green', 'enemy_car_yellow', 'enemy_car_blue_sky'];
        const randomCarKey = Phaser.Math.RND.pick(carTypes);
        const enemyCar = this.enemyCars.create(x, y, randomCarKey);
        enemyCar.body.setSize(60, 110);
        enemyCar.setVelocityY(this.enemySpeed);
    }

    // --- NEW: UPDATED CRASH LOGIC ---
    hitEnemy(player, enemyCar) {
        // If the player is already invincible, do nothing
        if (this.isInvincible) {
            return;
        }

        // We destroy the car that was hit
        enemyCar.destroy();
        
        // Lose a life
        this.lives--;
        this.livesText.setText('Lives: ' + this.lives);

        if (this.lives <= 0) {
            // Game Over if no lives are left
            this.physics.pause();
            this.spawnTimer.paused = true;
            this.scoreTimer.paused = true;
            this.scene.start('GameOverScene', { score: this.score });
        } else {
            // Become temporarily invincible if lives are left
            this.isInvincible = true;
            
            // A visual effect to show invincibility (blinking)
            this.tweens.add({
                targets: this.car,
                alpha: 0.5,
                duration: 200,
                ease: 'Power1',
                yoyo: true,
                repeat: 5, // Blink 5 times
                onComplete: () => {
                    this.car.setAlpha(1);
                    this.isInvincible = false;
                }
            });
        }
    }

    update() {
        this.road.tilePositionY -= this.roadSpeed;
        if (!this.isDragging) {
            this.car.body.setVelocity(0);
            if (this.cursors.left.isDown) this.car.body.setVelocityX(-this.playerSpeed);
            else if (this.cursors.right.isDown) this.car.body.setVelocityX(this.playerSpeed);
            if (this.cursors.up.isDown) this.car.body.setVelocityY(-this.playerSpeed);
            else if (this.cursors.down.isDown) this.car.body.setVelocityY(this.playerSpeed);
        }
        this.enemyCars.getChildren().forEach(enemyCar => {
            if (enemyCar.y > 650) {
                enemyCar.destroy();
            }
        });
    }
}
// SCENE 3: THE GAME OVER SCREEN
class GameOverScene extends Phaser.Scene {
    constructor() {
        super('GameOverScene');
    }
    init(data) {
        this.finalScore = data.score;
    }
    create() {
        this.add.text(400, 200, 'GAME OVER', { 
            fontSize: '64px', 
            fill: '#ff0000',
            fontStyle: 'bold' 
        }).setOrigin(0.5);
        this.add.text(400, 300, 'Your Score: ' + this.finalScore, { 
            fontSize: '32px', 
            fill: '#fff' 
        }).setOrigin(0.5);
        this.add.text(400, 400, 'Tap or Press SPACE to Restart', { 
            fontSize: '24px', 
            fill: '#fff' 
        }).setOrigin(0.5);
        this.input.keyboard.once('keydown-SPACE', () => {
            this.scene.start('GameScene');
        });
        this.input.on('pointerdown', () => {
            this.scene.start('GameScene');
        });
    }
}

// THE GAME CONFIGURATION
const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    backgroundColor: '#222',
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    },
    scene: [StartScene, GameScene, GameOverScene]
};

// Create the game instance
new Phaser.Game(config);
</script>
</body>
</html>
