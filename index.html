<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Nitro Lane Rush</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        #game-container {
            position: relative;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="game-container">
    <div class="loading">Loading Nitro Lane Rush...</div>
</div>
<script>
// Ultra-lightweight asset manager
class AssetManager {
    static createTextures(scene) {
        // Only create if not already exists
        if (!scene.textures.exists('particle')) {
            const g = scene.add.graphics();
            g.fillStyle(0xFFFFFF);
            g.fillCircle(2, 2, 2);
            g.generateTexture('particle', 4, 4);
            g.destroy();
        }
        
        if (!scene.textures.exists('powerup_shield')) {
            const g = scene.add.graphics();
            g.fillStyle(0x0066FF);
            g.fillCircle(0, 0, 15);
            g.fillStyle(0xFFFFFF);
            g.fillCircle(0, 0, 10);
            g.fillStyle(0x0066FF);
            g.fillCircle(0, 0, 5);
            g.generateTexture('powerup_shield', 30, 30);
            g.destroy();
        }
        
        if (!scene.textures.exists('nitro_pickup')) {
            const g = scene.add.graphics();
            g.fillStyle(0x00AAFF);
            g.fillCircle(0, 0, 12);
            g.fillStyle(0xFFFFFF);
            g.fillCircle(0, 0, 8);
            g.fillStyle(0x00AAFF);
            g.fillCircle(0, 0, 4);
            g.generateTexture('nitro_pickup', 24, 24);
            g.destroy();
        }
    }
}

// SCENE 1: ULTRA-LIGHT START SCREEN
class StartScene extends Phaser.Scene {
    constructor() {
        super('StartScene');
    }
    
    create() {
        document.querySelector('.loading').style.display = 'none';
        
        const title = this.add.text(400, 150, 'Nitro Lane Rush', { 
            fontSize: '48px', fill: '#fff', fontStyle: 'bold',
            stroke: '#FF6B00', strokeThickness: 3
        }).setOrigin(0.5);
        
        title.setScale(0);
        this.tweens.add({ targets: title, scale: 1, duration: 800, ease: 'Back.easeOut', delay: 200 });

        const startText = this.add.text(400, 300, 'Press SPACE or Tap to Start', { 
            fontSize: '24px', fill: '#00FF88', fontStyle: 'bold'
        }).setOrigin(0.5);
        
        this.tweens.add({ targets: startText, alpha: 0.3, duration: 1000, 
            ease: 'Sine.easeInOut', yoyo: true, repeat: -1 });

        const instructions = this.add.text(400, 350, 'Use Arrow Keys or Drag to Move', { 
            fontSize: '18px', fill: '#ccc' 
        }).setOrigin(0.5);
        
        instructions.setX(-200);
        this.tweens.add({ targets: instructions, x: 400, duration: 1000, 
            ease: 'Power2.easeOut', delay: 500 });

        const highScore = localStorage.getItem('nitroLaneRushHighScore') || 0;
        this.add.text(400, 380, `High Score: ${highScore}`, { 
            fontSize: '16px', fill: '#FFD700', fontStyle: 'bold'
        }).setOrigin(0.5);

        this.createSimpleBackground();
        
        this.game.canvas.setAttribute('tabindex', '0');
        this.game.canvas.focus();
        
        this.input.keyboard.once('keydown-SPACE', () => this.startGame());
        this.input.on('pointerdown', () => this.startGame());
    }

    createSimpleBackground() {
        // Minimal background elements
        for (let i = 0; i < 2; i++) {
            const line = this.add.rectangle(200 + i * 300, -50, 4, 100, 0x444444);
            this.tweens.add({ targets: line, y: 700, duration: 2500, 
                ease: 'Linear', repeat: -1, delay: i * 500 });
        }
    }

    startGame() {
        this.scene.start('GameScene');
    }
}

// SCENE 2: ULTRA-PERFORMANCE GAME SCENE
class GameScene extends Phaser.Scene {
    constructor() {
        super('GameScene');
        this.resetGameState();
    }
    
    resetGameState() {
        this.playerSpeed = 300;
        this.isDragging = false;
        this.score = 0;
        this.roadSpeed = 4;
        this.enemySpeed = 150;
        this.spawnDelay = 1500;
        this.lives = 3;
        this.isInvincible = false;
        this.policeSpeed = 100;
        this.currentTrackIndex = 0;
        this.streak = 0;
        this.nitroBoost = 100;
        this.isUsingNitro = false;
        this.comboMultiplier = 1;
        this.comboTimer = 0;
        this.isPaused = false;
        this.musicVolume = 0.5;
        this.sfxVolume = 0.7;
        this.frameSkip = 0;
        
        // Minimal pools
        this.enemyCarPool = [];
        this.policeCarPool = [];
        this.roadblockPool = [];
        this.nitroPickupPool = [];
        this.powerUpPool = [];
        this.maxPoolSize = 10;
    }

    preload() {
        document.querySelector('.loading').style.display = 'block';
        
        // Load assets
        this.load.image('road', 'assets/road.png');
        this.load.image('player_car_hero', 'assets/player_car_hero.png');
        this.load.image('enemy_car_green', 'assets/enemy_car_green.png');
        this.load.image('enemy_car_yellow', 'assets/enemy_car_yellow.png');
        this.load.image('enemy_car_blue_sky', 'assets/enemy_car_blue_sky.png');
        this.load.image('enemy_car_police', 'assets/enemy_car_police.png');
        this.load.image('obstacle_roadblock_a', 'assets/obstacle_roadblock_a.png');

        this.load.audio('music_1', 'assets/music_1.mp3');
        this.load.audio('music_2', 'assets/music_2.mp3');
        this.load.audio('music_3', 'assets/music_3.mp3');
        this.load.audio('music_4', 'assets/music_4.mp3');
        this.load.audio('sfx_crash', 'assets/crash.mp3');
        this.load.audio('sfx_powerup', 'assets/powerup.mp3');
        this.load.audio('sfx_nitro', 'assets/nitro.mp3');
        
        this.load.once('complete', () => {
            AssetManager.createTextures(this);
            document.querySelector('.loading').style.display = 'none';
        });
    }

    create() {
        this.resetGameState();
        
        // Road
        this.road = this.add.tileSprite(400, 300, 800, 600, 'road');

        // Player Car
        this.car = this.physics.add.sprite(400, 500, 'player_car_hero');
        this.car.setCollideWorldBounds(true);
        this.car.body.setSize(45, 130);
        this.car.setInteractive();
        
        // Input
        this.input.setDraggable(this.car);
        this.input.on('dragstart', () => { this.isDragging = true; });
        this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
            const clampedX = Phaser.Math.Clamp(dragX, 120, 680);
            const clampedY = Phaser.Math.Clamp(dragY, 50, 550);
            gameObject.setPosition(clampedX, clampedY);
        });
        this.input.on('dragend', () => { this.isDragging = false; });
        
        // Music
        this.sound.stopAll();
        this.musicPlaylist = ['music_1', 'music_2', 'music_3', 'music_4'];
        this.playNextTrack();

        // Object groups
        this.enemyCars = this.physics.add.group();
        this.policeCars = this.physics.add.group();
        this.roadblocks = this.physics.add.group();
        this.powerUps = this.physics.add.group();
        this.nitroPickups = this.physics.add.group();
        
        this.initializeMinimalPools();
        
        // Timers
        this.spawnTimer = this.time.addEvent({ delay: this.spawnDelay, 
            callback: this.spawnEnemyCar, callbackScope: this, loop: true });
        this.policeSpawnTimer = this.time.addEvent({ delay: 8000, 
            callback: this.spawnPoliceCar, callbackScope: this, loop: true });
        this.roadblockSpawnTimer = this.time.addEvent({ delay: 4000, 
            callback: this.spawnRoadblock, callbackScope: this, loop: true, paused: true });
        this.powerUpSpawnTimer = this.time.addEvent({ delay: 15000, 
            callback: this.spawnPowerUp, callbackScope: this, loop: true });
        this.nitroPickupSpawnTimer = this.time.addEvent({ delay: 20000, 
            callback: this.spawnNitroPickup, callbackScope: this, loop: true });

        // Collisions
        this.physics.add.overlap(this.car, this.enemyCars, this.hitEnemy, null, this);
        this.physics.add.overlap(this.car, this.policeCars, this.hitEnemy, null, this);
        this.physics.add.overlap(this.car, this.roadblocks, this.hitRoadblock, null, this);
        this.physics.add.overlap(this.car, this.powerUps, this.collectPowerUp, null, this);
        this.physics.add.overlap(this.car, this.nitroPickups, this.collectNitro, null, this);
        
        // UI
        this.cursors = this.input.keyboard.createCursorKeys();
        this.scoreText = this.add.text(16, 16, 'Score: 0', { 
            fontSize: '32px', fill: '#fff', fontStyle: 'bold',
            stroke: '#000', strokeThickness: 2
        });
        this.livesText = this.add.text(620, 16, 'Lives: 3', { 
            fontSize: '32px', fill: '#fff', fontStyle: 'bold',
            stroke: '#000', strokeThickness: 2
        });
        
        // Nitro UI
        this.nitroBarBg = this.add.rectangle(16, 90, 200, 20, 0x333333);
        this.nitroBarBg.setOrigin(0, 0);
        this.nitroBar = this.add.rectangle(16, 90, 200, 20, 0x00AAFF);
        this.nitroBar.setOrigin(0, 0);
        this.nitroText = this.add.text(16, 90, 'NITRO: 100%', { 
            fontSize: '16px', fill: '#fff', stroke: '#000', strokeThickness: 1
        }).setOrigin(0, 0);

        // Particle systems (minimal)
        this.createMinimalParticles();
        
        this.scoreTimer = this.time.addEvent({ delay: 100, 
            callback: this.updateScore, callbackScope: this, loop: true });
    }

    createMinimalParticles() {
        // Simple exhaust (no follow)
        this.exhaustEmitter = this.add.particles(0, 0, 'particle', {
            speed: { min: 20, max: 40 },
            scale: { start: 0.3, end: 0 },
            alpha: { start: 0.6, end: 0 },
            lifespan: 300,
            frequency: 300,
            tint: 0x666666,
            maxParticles: 30
        });
        this.exhaustEmitter.stop();
        
        // Simple nitro (no follow)
        this.nitroEmitter = this.add.particles(0, 0, 'particle', {
            speed: { min: 100, max: 200 },
            scale: { start: 0.5, end: 0 },
            alpha: { start: 1, end: 0 },
            lifespan: 200,
            frequency: 150,
            tint: 0x00AAFF,
            blendMode: 'ADD',
            maxParticles: 20
        });
        this.nitroEmitter.stop();
    }

    initializeMinimalPools() {
        const carTypes = ['enemy_car_green', 'enemy_car_yellow', 'enemy_car_blue_sky'];
        
        for (let i = 0; i < this.maxPoolSize; i++) {
            const carType = carTypes[i % carTypes.length];
            const car = this.physics.add.sprite(-100, -100, carType);
            car.setActive(false).setVisible(false);
            car.body.setSize(45, 100);
            this.enemyCarPool.push(car);
            this.enemyCars.add(car);
        }
        
        for (let i = 0; i < 5; i++) {
            const car = this.physics.add.sprite(-100, -100, 'enemy_car_police');
            car.setActive(false).setVisible(false);
            car.body.setSize(50, 120);
            car.setData('isChasing', false);
            this.policeCarPool.push(car);
            this.policeCars.add(car);
        }
        
        for (let i = 0; i < 8; i++) {
            const roadblock = this.physics.add.sprite(-100, -100, 'obstacle_roadblock_a');
            roadblock.setActive(false).setVisible(false);
            roadblock.setScale(2);
            roadblock.body.setSize(roadblock.width * 0.8, roadblock.height * 0.8);
            this.roadblockPool.push(roadblock);
            this.roadblocks.add(roadblock);
        }
        
        for (let i = 0; i < 5; i++) {
            const powerUp = this.physics.add.sprite(-100, -100, 'powerup_shield');
            powerUp.setActive(false).setVisible(false);
            powerUp.setScale(1.5);
            this.powerUpPool.push(powerUp);
            this.powerUps.add(powerUp);
        }
        
        for (let i = 0; i < 5; i++) {
            const nitroPickup = this.physics.add.sprite(-100, -100, 'nitro_pickup');
            nitroPickup.setActive(false).setVisible(false);
            nitroPickup.setScale(1.5);
            this.nitroPickupPool.push(nitroPickup);
            this.nitroPickups.add(nitroPickup);
        }
    }

    playNextTrack() {
        if (this.currentTrackIndex >= this.musicPlaylist.length) {
            this.currentTrackIndex = 0;
        }
        const trackKey = this.musicPlaylist[this.currentTrackIndex];
        this.currentMusic = this.sound.add(trackKey, { volume: this.musicVolume });
        this.currentMusic.play();
        this.currentTrackIndex++;
        this.currentMusic.on('complete', this.playNextTrack, this);
    }

    updateScore() {
        this.score += 1 * this.comboMultiplier;
        this.scoreText.setText('Score: ' + this.score);
        
        if (this.comboTimer > 0) {
            this.comboTimer--;
            if (this.comboTimer <= 0) {
                this.comboMultiplier = 1;
            }
        }
        
        if (this.score > 0 && this.score % 200 === 0 && this.spawnDelay > 600) {
            this.roadSpeed = Math.min(this.roadSpeed + 0.3, 8);
            this.enemySpeed = Math.min(this.enemySpeed + 15, 300);
            this.policeSpeed = Math.min(this.policeSpeed + 20, 200);
            this.spawnTimer.delay = Math.max(this.spawnTimer.delay * 0.96, 400);
            
            if (!this.roadblockSpawnTimer.paused && this.roadblockSpawnTimer.delay > 1500) {
                this.roadblockSpawnTimer.delay = Math.max(this.roadblockSpawnTimer.delay * 0.96, 1000);
            }
        }
        
        if (this.score >= 500 && this.roadblockSpawnTimer.paused) {
            this.roadblockSpawnTimer.paused = false;
        }
    }
    
    spawnRoadblock() {
        const roadblock = this.getFromPool(this.roadblockPool, (obj) => {
            const x = Phaser.Math.Between(120, 680);
            obj.setPosition(x, -50);
            obj.setScale(2);
        });
    }
    
    spawnPowerUp() {
        const powerUp = this.getFromPool(this.powerUpPool, (obj) => {
            const x = Phaser.Math.Between(140, 660);
            obj.setPosition(x, -50);
            obj.setTexture('powerup_shield');
            obj.setScale(1.5);
            obj.setVelocityY(100);
        });
    }
    
    spawnNitroPickup() {
        const nitroPickup = this.getFromPool(this.nitroPickupPool, (obj) => {
            const x = Phaser.Math.Between(140, 660);
            obj.setPosition(x, -50);
            obj.setTexture('nitro_pickup');
            obj.setScale(1.5);
            obj.setVelocityY(80);
        });
    }
    
    collectPowerUp(player, powerUp) {
        this.returnPowerUpToPool(powerUp);
        if (this.sound && this.sfx_powerup) {
            this.sound.play('sfx_powerup', { volume: this.sfxVolume });
        }
        
        if (!this.isInvincible) {
            this.isInvincible = true;
            this.time.delayedCall(3000, () => {
                this.isInvincible = false;
            });
        }
    }
    
    collectNitro(player, nitroPickup) {
        this.returnNitroToPool(nitroPickup);
        if (this.sound && this.sfx_powerup) {
            this.sound.play('sfx_powerup', { volume: this.sfxVolume });
        }
        this.nitroBoost = Math.min(this.nitroBoost + 30, 100);
        this.updateNitroBar();
    }
    
    updateNitroBar() {
        const width = 200 * (this.nitroBoost / 100);
        this.nitroBar.width = width;
        this.nitroText.setText(`NITRO: ${Math.floor(this.nitroBoost)}%`);
        this.nitroBar.setFillStyle(this.nitroBoost < 20 ? 0xFF0000 : 0x00AAFF);
    }
    
    activateNitro() {
        if (this.nitroBoost > 0 && !this.isUsingNitro) {
            this.isUsingNitro = true;
            if (this.sound && this.sfx_nitro) {
                this.sound.play('sfx_nitro', { volume: this.sfxVolume });
            }
            this.nitroEmitter.start();
        }
    }
    
    deactivateNitro() {
        if (this.isUsingNitro) {
            this.isUsingNitro = false;
            this.nitroEmitter.stop();
        }
    }
    
    hitRoadblock(player, roadblock) {
        if (this.isInvincible) {
            this.returnToPool(roadblock);
            return;
        }
        
        if (this.sound && this.sfx_crash) {
            this.sound.play('sfx_crash', { volume: this.sfxVolume });
        }
        this.returnToPool(roadblock);
        this.gameOver();
    }

    spawnEnemyCar() {
        const enemyCar = this.getFromPool(this.enemyCarPool, (car) => {
            const x = Phaser.Math.Between(120, 680);
            car.setPosition(x, -50);
            car.setVelocityY(this.enemySpeed);
        });
    }

    spawnPoliceCar() {
        const policeCar = this.getFromPool(this.policeCarPool, (car) => {
            const side = Phaser.Math.RND.pick(['left', 'right']);
            const yPos = Phaser.Math.RND.pick([150, 450]);
            let startX = side === 'left' ? -50 : 850;
            
            car.setPosition(startX, yPos);
            car.setData('isChasing', false);
            car.setVelocityX(side === 'left' ? 100 : -100);
            
            this.time.delayedCall(800, () => {
                if (car.active) {
                    const targetX = side === 'left' ? 160 : 640;
                    car.setVelocityX(0);
                    car.setVelocityY(this.enemySpeed * 0.9);
                    car.setData('isChasing', true);
                }
            });
        });
    }

    hitEnemy(player, enemyCar) {
        if (this.isInvincible) {
            this.returnToPool(enemyCar);
            return;
        }
        
        if (this.sound && this.sfx_crash) {
            this.sound.play('sfx_crash', { volume: this.sfxVolume });
        }
        this.returnToPool(enemyCar);
        
        this.lives--;
        this.livesText.setText('Lives: ' + this.lives);
        
        if (this.lives <= 0) {
            this.gameOver();
        } else {
            this.isInvincible = true;
            this.time.delayedCall(1500, () => {
                this.isInvincible = false;
            });
        }
    }

    gameOver() {
        const highScore = localStorage.getItem('nitroLaneRushHighScore') || 0;
        if (this.score > highScore) {
            localStorage.setItem('nitroLaneRushHighScore', this.score);
        }
        
        if (this.currentMusic) { 
            try { this.currentMusic.stop(); } catch(e) {} 
        }
        
        this.nitroEmitter.stop();
        this.exhaustEmitter.stop();
        this.deactivateNitro();
        
        // Force cleanup
        this.cleanupAllObjects();
        
        this.time.delayedCall(1000, () => {
            this.scene.start('GameOverScene', { score: this.score });
        });
    }

    cleanupAllObjects() {
        // Force destroy all active objects
        [...this.enemyCars.children.entries].forEach(obj => {
            if (obj.active) obj.destroy();
        });
        
        [...this.policeCars.children.entries].forEach(obj => {
            if (obj.active) obj.destroy();
        });
        
        [...this.roadblocks.children.entries].forEach(obj => {
            if (obj.active) obj.destroy();
        });
        
        [...this.powerUps.children.entries].forEach(obj => {
            if (obj.active) obj.destroy();
        });
        
        [...this.nitroPickups.children.entries].forEach(obj => {
            if (obj.active) obj.destroy();
        });
        
        // Stop all timers
        if (this.spawnTimer) this.spawnTimer.remove();
        if (this.policeSpawnTimer) this.policeSpawnTimer.remove();
        if (this.roadblockSpawnTimer) this.roadblockSpawnTimer.remove();
        if (this.powerUpSpawnTimer) this.powerUpSpawnTimer.remove();
        if (this.nitroPickupSpawnTimer) this.nitroPickupSpawnTimer.remove();
        if (this.scoreTimer) this.scoreTimer.remove();
    }

    getFromPool(pool, resetCallback) {
        for (let obj of pool) {
            if (!obj.active) {
                obj.setActive(true).setVisible(true);
                resetCallback(obj);
                return obj;
            }
        }
        return null;
    }

    returnToPool(object) {
        if (!object) return;
        object.setActive(false).setVisible(false);
        object.body.setVelocity(0, 0);
        object.body.setAcceleration(0, 0);
        object.setPosition(-100, -100);
        object.setScale(1);
        object.setAlpha(1);
        if (object.setData) object.setData('isChasing', false);
    }
    
    returnNitroToPool(object) {
        if (!object) return;
        object.setActive(false).setVisible(false);
        object.body.setVelocity(0, 0);
        object.setPosition(-100, -100);
        object.setScale(1.5);
        object.setAlpha(1);
        object.setTexture('nitro_pickup');
    }
    
    returnPowerUpToPool(object) {
        if (!object) return;
        object.setActive(false).setVisible(false);
        object.body.setVelocity(0, 0);
        object.setPosition(-100, -100);
        object.setScale(1.5);
        object.setAlpha(1);
        object.setTexture('powerup_shield');
    }

    update() {
        if (!this.car || !this.car.body) return;
        
        this.road.tilePositionY -= this.roadSpeed;
        
        if (!this.isDragging) {
            this.car.body.setVelocity(0);
            
            let currentSpeed = this.playerSpeed;
            
            if (this.isUsingNitro && this.nitroBoost > 0) {
                currentSpeed *= 2;
                this.nitroBoost -= 0.5;
                this.updateNitroBar();
            } else if (this.isUsingNitro && this.nitroBoost <= 0) {
                this.deactivateNitro();
            }
            
            const acceleration = currentSpeed * 1.2;
            if (this.cursors.left.isDown && this.car.x > 120) { 
                this.car.body.setVelocityX(-acceleration);
            } else if (this.cursors.right.isDown && this.car.x < 680) { 
                this.car.body.setVelocityX(acceleration);
            }
            
            if (this.cursors.up.isDown && this.car.y > 50) { 
                this.car.body.setVelocityY(-acceleration);
            } else if (this.cursors.down.isDown && this.car.y < 550) { 
                this.car.body.setVelocityY(acceleration);
            }
            
            try {
                if (this.cursors.shift && this.cursors.shift.isDown && this.nitroBoost > 0) {
                    this.activateNitro();
                } else if (this.cursors.shift && this.cursors.shift.isUp && this.isUsingNitro) {
                    this.deactivateNitro();
                }
            } catch (e) {
                // Silent fail
            }
        }

        this.cleanupOffscreenObjects();
        this.updatePoliceAI();
    }

    cleanupOffscreenObjects() {
        this.enemyCars.children.entries.forEach(car => {
            if (car.active && car.y > 650) this.returnToPool(car);
        });
        
        this.policeCars.children.entries.forEach(car => {
            if (car.active && car.y > 700) this.returnToPool(car);
        });
        
        this.roadblocks.children.entries.forEach(roadblock => {
            if (roadblock.active && roadblock.y > 650) this.returnToPool(roadblock);
        });
        
        this.nitroPickups.children.entries.forEach(nitroPickup => {
            if (nitroPickup.active) {
                nitroPickup.y += this.roadSpeed;
                if (nitroPickup.y > 650) this.returnNitroToPool(nitroPickup);
            }
        });
        
        this.powerUps.children.entries.forEach(powerUp => {
            if (powerUp.active) {
                powerUp.y += this.roadSpeed;
                if (powerUp.y > 650) this.returnPowerUpToPool(powerUp);
            }
        });
    }

    updatePoliceAI() {
        this.policeCars.children.entries.forEach(policeCar => {
            if (policeCar.active && policeCar.getData('isChasing')) {
                const dx = this.car.x - policeCar.x;
                const targetSpeed = this.policeSpeed * 0.8;
                
                if (Math.abs(dx) > 15) {
                    const acceleration = dx > 0 ? targetSpeed : -targetSpeed;
                    policeCar.body.setAccelerationX(acceleration);
                } else {
                    policeCar.body.setAccelerationX(0);
                }
            }
        });
    }
}

// SCENE 3: ULTRA-LIGHT GAME OVER
class GameOverScene extends Phaser.Scene {
    constructor() {
        super('GameOverScene');
    }
    
    init(data) {
        this.finalScore = data.score;
    }
    
    create() {
        document.querySelector('.loading').style.display = 'none';
        
        this.add.text(400, 200, 'GAME OVER', { 
            fontSize: '64px', fill: '#ff0000', fontStyle: 'bold',
            stroke: '#000', strokeThickness: 4
        }).setOrigin(0.5);
        
        this.add.text(400, 300, 'Your Score: ' + this.finalScore, { 
            fontSize: '32px', fill: '#fff'
        }).setOrigin(0.5);

        const highScore = localStorage.getItem('nitroLaneRushHighScore') || 0;
        if (this.finalScore >= highScore) {
            this.add.text(400, 350, 'NEW HIGH SCORE!', { 
                fontSize: '28px', fill: '#FFD700', fontStyle: 'bold'
            }).setOrigin(0.5);
        }

        this.add.text(400, 400, 'Tap or Press SPACE to Restart', { 
            fontSize: '24px', fill: '#fff'
        }).setOrigin(0.5);
        
        this.input.keyboard.once('keydown-SPACE', () => {
            this.scene.start('GameScene');
        });
        this.input.on('pointerdown', () => {
            this.scene.start('GameScene');
        });
    }
}

// ULTRA-PERFORMANCE CONFIG
const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    backgroundColor: '#222',
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false,
            fps: 60
        }
    },
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    },
    render: {
        antialias: false,
        pixelArt: true,
        roundPixels: true
    },
    scene: [StartScene, GameScene, GameOverScene]
};

// SAFER GAME INITIALIZATION
window.addEventListener('load', () => {
    try {
        window.game = new Phaser.Game(config);
    } catch (e) {
        console.error('Game initialization failed:', e);
        document.querySelector('.loading').innerHTML = 'Error loading game. Please refresh.';
    }
});

// FORCE CLEANUP ON UNLOAD
window.addEventListener('beforeunload', () => {
    if (window.game) {
        try {
            window.game.destroy(true);
        } catch (e) {
            console.error('Cleanup error:', e);
        }
    }
});
</script>
</body>
</html>
